---
import Sidebar from '@/components/Sidebar.astro'
import Layout from '@/layouts/Layout.astro'
import { makeSortedCategoryEntries } from '@/utils/content'
import { compareUrlPaths } from '@/utils/url'
import Navbar from '@/components/Navbar.astro'

type DocHeading = {
    depth: number
    text: string
    slug: string
}

type TocLine = DocHeading & {
    treePrefix: string
}

const { frontmatter, headings } = Astro.props as {
    frontmatter: { title: string }
    headings: DocHeading[]
}

const sortedPages = makeSortedCategoryEntries().flatMap(
    (category) => category[1],
)
const pageIndex = sortedPages.findIndex((page) =>
    compareUrlPaths(page.id, Astro.url.pathname),
)
const nextDoc =
    pageIndex === sortedPages.length - 1
        ? undefined
        : sortedPages.at(pageIndex + 1)
const prevDoc = pageIndex === 0 ? undefined : sortedPages.at(pageIndex - 1)

const tocHeadings: DocHeading[] = [
    {
        depth: 1,
        text: frontmatter.title,
        slug: 'toc-page-title',
    },
    ...headings.filter((heading) => heading.depth >= 2),
]

const hasSiblingAfter = (items: DocHeading[], index: number) => {
    const currentDepth = items[index].depth

    for (let nextIndex = index + 1; nextIndex < items.length; nextIndex += 1) {
        const nextDepth = items[nextIndex].depth

        if (nextDepth === currentDepth) return true
        if (nextDepth < currentDepth) return false
    }

    return false
}

const ancestorHasSibling = new Map<number, boolean>()
const tocLines: TocLine[] = tocHeadings.map((heading, index) => {
    const isLastSibling = !hasSiblingAfter(tocHeadings, index)

    let ancestorPrefix = ''
    for (let level = 2; level < heading.depth; level += 1) {
        ancestorPrefix += ancestorHasSibling.get(level) ? '│ ' : '  '
    }

    const branchPrefix =
        heading.depth === 1 ? '' : isLastSibling ? '└─ ' : '├─ '

    ancestorHasSibling.set(heading.depth, !isLastSibling)

    return {
        ...heading,
        treePrefix: `${ancestorPrefix}${branchPrefix}`,
    }
})
---

<style is:global>
    @import './Doc.css';
</style>

<Layout>
    <column self-="grow">
        <Navbar />
        <row self-="grow" gap-="1">
            <div id="sidebar-container" class="mobile-hidden">
                <Sidebar />
            </div>
            <div id="sidebar-resizer" aria-hidden="true"></div>
            <article box-="square" shear-="top">
                <header is-="row" align-="between">
                    <div is-="badge" variant-="background0">
                        <h1>{frontmatter.title}</h1>
                    </div>
                </header>
                <row gap-="1" self-="grow">
                    <div id="scroll-container">
                        <main id="main-content">
                            <span id="toc-page-title" aria-hidden="true"></span>
                            <slot />
                            <div id="doc-pagination">
                                {
                                    prevDoc && (
                                        <a
                                            href={`/${prevDoc.id}`}
                                            class="prev"
                                            box-="round"
                                            shear-="top"
                                            tabindex="0">
                                            <div is-="typography-block">
                                                <span
                                                    is-="badge"
                                                    variant-="background0">
                                                    <row gap-="1">
                                                        <span>←</span>
                                                        <code>&lt;C-p&gt;</code>
                                                        <span>Previous</span>
                                                    </row>
                                                </span>
                                            </div>
                                            <span pad-="1 0">
                                                {prevDoc.id.split('/')[0]}/
                                                {prevDoc.data.title}
                                            </span>
                                        </a>
                                    )
                                }
                                {
                                    nextDoc && (
                                        <a
                                            href={`/${nextDoc.id}`}
                                            class="next"
                                            box-="round"
                                            shear-="top"
                                            tabindex="0">
                                            <row
                                                align-="start end"
                                                is-="typography-block">
                                                <span
                                                    is-="badge"
                                                    variant-="background0">
                                                    <row gap-="1">
                                                        <span>Next</span>
                                                        <code>&lt;C-n&gt;</code>
                                                        <span>→</span>
                                                    </row>
                                                </span>
                                            </row>
                                            <span pad-="1 0">
                                                {nextDoc.id.split('/')[0]}/
                                                {nextDoc.data.title}
                                            </span>
                                        </a>
                                    )
                                }
                            </div>
                        </main>
                    </div>
                </row>
            </article>
            {
                tocHeadings.length > 0 && (
                    <>
                        <div id="toc-resizer" aria-hidden="true" />
                        <aside id="toc-container" class="mobile-hidden">
                            <nav
                                box-="square"
                                shear-="top"
                                id="toc-sidebar"
                                aria-label="Table of contents">
                                <div id="toc-list-container">
                                    <ul id="toc-list">
                                        {tocLines.map((heading) => (
                                            <li>
                                                <a
                                                    href={`#${heading.slug}`}
                                                    class={`toc-link depth-${heading.depth}`}
                                                    data-heading-slug={
                                                        heading.slug
                                                    }>
                                                    <span
                                                        class="toc-tree-prefix"
                                                        data-tree-prefix={
                                                            heading.treePrefix
                                                        }
                                                        aria-hidden="true"
                                                    />
                                                    <span>{heading.text}</span>
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </nav>
                        </aside>
                    </>
                )
            }
        </row>
        <div id="mobile-nav">
            <button variant-="background1" id="menu-button">
                &#xeb86; Menu
            </button>
            <button id="docs-button">&#xf15b; Docs</button>
        </div>
    </column>
</Layout>

<!-- Vim Navigation -->
<script>
    import {
        applyVimNavigation,
        isUserTyping,
        vimFocusElement,
    } from '@/utils/vim'

    const queryString =
        '#main-content [tabindex="0"], #main-content a[href], #main-content summary'

    const vimTabbableElements: NodeListOf<HTMLElement> =
        document.querySelectorAll(queryString)

    let currentElement: HTMLElement | null = null

    const findFirstFocusableElement = () =>
        Array.from(vimTabbableElements).find((el) => {
            const rect = el.getBoundingClientRect()

            return rect.top >= 0 && rect.bottom <= window.innerHeight
        })

    const mainContent = document.getElementById('main-content') as HTMLElement
    const sidebar = document.getElementById('sidebar') as HTMLElement | null
    const tocSidebar = document.getElementById(
        'toc-sidebar',
    ) as HTMLElement | null
    const getSidebarTarget = () =>
        sidebar?.querySelector('a.active') ||
        sidebar?.querySelector('details summary') ||
        sidebar?.querySelector('a')
    const getTocTarget = () =>
        tocSidebar?.querySelector('a.active') || tocSidebar?.querySelector('a')

    const isFocusableElement = (element: Element) =>
        element.matches(
            'a[href], button, input, textarea, select, summary, [tabindex]:not([tabindex="-1"])',
        )

    const applyMainContentTabIndex = () => {
        const children = Array.from(mainContent.children)
        children.forEach((child) => {
            if (!(child instanceof HTMLElement)) return
            if (isFocusableElement(child)) return
            if (child.hasAttribute('tabindex')) return
            child.setAttribute('tabindex', '0')
        })

        const listItems = Array.from(mainContent.querySelectorAll('li'))
        listItems.forEach((item) => {
            if (!(item instanceof HTMLElement)) return
            if (isFocusableElement(item)) return
            if (item.hasAttribute('tabindex')) return
            item.setAttribute('tabindex', '0')
        })
    }

    applyMainContentTabIndex()

    window.addEventListener('keydown', (e) => {
        if (e.defaultPrevented) return

        const commandDialog = document.getElementById(
            'command-dialog',
        ) as HTMLDialogElement | null

        if (commandDialog?.open) return

        // Don't navigate if the user is typing
        if (isUserTyping()) {
            return
        }

        // ctrl-o -> "navigate out"
        if (e.key === 'o' && e.ctrlKey) {
            e.preventDefault()
            window.history.back()
        }

        // ctrl-i -> "navigate in"
        if (e.key === 'i' && e.ctrlKey) {
            e.preventDefault()
            window.history.forward()
        }

        if (e.key === 'h') {
            const activeElement = document.activeElement

            if (activeElement && mainContent.contains(activeElement)) {
                e.preventDefault()
                const target = getSidebarTarget()
                if (target instanceof HTMLElement) {
                    vimFocusElement(target)
                }
                return
            }

            if (activeElement && tocSidebar?.contains(activeElement)) {
                e.preventDefault()
                const elementToFocus =
                    currentElement ?? findFirstFocusableElement() ?? null

                if (elementToFocus) {
                    vimFocusElement(elementToFocus)
                }
                return
            }
        }

        if (e.key === 'l') {
            const activeElement = document.activeElement

            if (activeElement && sidebar?.contains(activeElement)) {
                e.preventDefault()
                const elementToFocus =
                    currentElement ?? findFirstFocusableElement() ?? null

                if (elementToFocus) {
                    vimFocusElement(elementToFocus)
                }
                return
            }

            if (activeElement && mainContent.contains(activeElement)) {
                const target = getTocTarget()
                if (target instanceof HTMLElement) {
                    e.preventDefault()
                    vimFocusElement(target)
                }
            }
        }

        const nextHref = document.querySelector('.next')?.getAttribute('href')
        const prevHref = document.querySelector('.prev')?.getAttribute('href')

        if (e.key === 'n' && e.ctrlKey && nextHref) {
            window.location.href = nextHref
        }

        if (e.key === 'p' && e.ctrlKey && prevHref) {
            window.location.href = prevHref
        }
    })

    applyVimNavigation(mainContent, queryString, (element) => {
        currentElement = element
    })

    if (tocSidebar) {
        applyVimNavigation(tocSidebar, 'a[href]')
    }
</script>

<!-- Heading Anchor Links -->
<script>
    const headingContainer = document.getElementById('main-content')

    if (headingContainer) {
        const headingNodes = headingContainer.querySelectorAll(
            'h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]',
        )

        headingNodes.forEach((heading) => {
            if (!(heading instanceof HTMLElement)) return
            if (heading.querySelector(':scope > a.heading-anchor')) return

            const slug = heading.id
            if (!slug) return

            const anchor = document.createElement('a')
            anchor.className = 'heading-anchor'
            anchor.href = `#${slug}`
            anchor.setAttribute(
                'aria-label',
                `Link to section ${heading.textContent ?? ''}`,
            )
            anchor.textContent = '#'
            heading.append(anchor)
        })
    }
</script>

<!-- TOC Active Heading -->
<script>
    const mainContent = document.getElementById(
        'main-content',
    ) as HTMLElement | null
    const tocLinks = Array.from(
        document.querySelectorAll('#toc-list a[data-heading-slug]'),
    ) as HTMLAnchorElement[]

    if (mainContent && tocLinks.length > 0) {
        const headingElements = tocLinks
            .map((link) => {
                const slug = link.dataset.headingSlug
                if (!slug) return null
                return document.getElementById(slug)
            })
            .filter(
                (element): element is HTMLElement =>
                    element instanceof HTMLElement,
            )

        const setActiveTocLink = (activeId: string) => {
            tocLinks.forEach((link) => {
                const slug = link.dataset.headingSlug
                link.classList.toggle('active', slug === activeId)
            })
        }

        const syncActiveHeading = () => {
            const scrollTop = mainContent.scrollTop
            let activeHeading = headingElements[0]

            for (const heading of headingElements) {
                if (heading.offsetTop - 24 <= scrollTop) {
                    activeHeading = heading
                } else {
                    break
                }
            }

            if (activeHeading) {
                setActiveTocLink(activeHeading.id)
                const activeLink = document.querySelector(
                    '#toc-list a.active',
                ) as HTMLAnchorElement | null
                activeLink?.scrollIntoView({ block: 'nearest' })
            }
        }

        mainContent.addEventListener('scroll', syncActiveHeading, {
            passive: true,
        })
        window.addEventListener('hashchange', syncActiveHeading)
        syncActiveHeading()
    }
</script>

<!-- Sidebar Toggle -->
<script>
    import { isUserTyping } from '@/utils/vim'

    const sidebarToggle = document.getElementById(
        'sidebar-toggle',
    ) as HTMLButtonElement | null
    const sidebarContainer = document.getElementById(
        'sidebar-container',
    ) as HTMLDivElement | null

    if (sidebarToggle && sidebarContainer) {
        const setSidebarToggleLabel = () => {
            sidebarToggle.innerHTML = '<code>&lt;C-b&gt;</code>'
            sidebarToggle.setAttribute('aria-label', 'Toggle sidebar (Ctrl+B)')
        }

        const setSidebarCollapsed = (collapsed: boolean) => {
            sidebarContainer.classList.toggle('collapsed', collapsed)
            sidebarToggle.setAttribute('aria-expanded', String(!collapsed))
            localStorage.setItem('sidebar-collapsed', String(collapsed))
            setSidebarToggleLabel()
        }

        const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true'
        setSidebarCollapsed(isCollapsed)

        sidebarToggle.addEventListener('click', () => {
            setSidebarCollapsed(
                !sidebarContainer.classList.contains('collapsed'),
            )
        })

        window.addEventListener('keydown', (e) => {
            if (isUserTyping()) return
            if (e.key === 'b' && e.ctrlKey) {
                e.preventDefault()
                setSidebarCollapsed(
                    !sidebarContainer.classList.contains('collapsed'),
                )
            }
        })
    }
</script>

<!-- TOC Resize -->
<script>
    const tocContainer = document.getElementById(
        'toc-container',
    ) as HTMLElement | null
    const tocResizer = document.getElementById(
        'toc-resizer',
    ) as HTMLDivElement | null

    if (tocContainer && tocResizer) {
        const setTocWidth = (widthPx: number) => {
            tocContainer.style.setProperty('--toc-width', `${widthPx}px`)
        }

        const getBounds = () => {
            const styles = window.getComputedStyle(tocContainer)
            const minWidth = parseFloat(styles.minWidth)
            const maxWidth = parseFloat(styles.maxWidth)
            return { minWidth, maxWidth }
        }

        const storedWidth = localStorage.getItem('toc-width')
        if (storedWidth) {
            const widthPx = Number(storedWidth)
            if (!Number.isNaN(widthPx)) {
                setTocWidth(widthPx)
            }
        }

        const onMouseMove = (event: MouseEvent) => {
            const { right } = tocContainer.getBoundingClientRect()
            const { minWidth, maxWidth } = getBounds()
            const rawWidth = right - event.clientX
            const nextWidth = Math.min(maxWidth, Math.max(minWidth, rawWidth))
            setTocWidth(nextWidth)
        }

        const onMouseUp = () => {
            tocResizer.classList.remove('dragging')
            const styles = window.getComputedStyle(tocContainer)
            const widthPx = parseFloat(styles.width)
            if (!Number.isNaN(widthPx)) {
                localStorage.setItem('toc-width', String(widthPx))
            }
            window.removeEventListener('mousemove', onMouseMove)
            window.removeEventListener('mouseup', onMouseUp)
        }

        tocResizer.addEventListener('mousedown', (event) => {
            event.preventDefault()
            tocResizer.classList.add('dragging')
            window.addEventListener('mousemove', onMouseMove)
            window.addEventListener('mouseup', onMouseUp)
        })
    }
</script>

<!-- Sidebar Resize -->
<script>
    const sidebarContainer = document.getElementById(
        'sidebar-container',
    ) as HTMLDivElement | null
    const sidebarResizer = document.getElementById(
        'sidebar-resizer',
    ) as HTMLDivElement | null

    if (sidebarContainer && sidebarResizer) {
        const setSidebarWidth = (widthPx: number) => {
            sidebarContainer.style.setProperty(
                '--sidebar-width',
                `${widthPx}px`,
            )
        }

        const getBounds = () => {
            const styles = window.getComputedStyle(sidebarContainer)
            const minWidth = parseFloat(styles.minWidth)
            const maxWidth = parseFloat(styles.maxWidth)
            return { minWidth, maxWidth }
        }

        const storedWidth = localStorage.getItem('sidebar-width')
        if (storedWidth) {
            const widthPx = Number(storedWidth)
            if (!Number.isNaN(widthPx)) {
                setSidebarWidth(widthPx)
            }
        }

        const onMouseMove = (event: MouseEvent) => {
            const { left } = sidebarContainer.getBoundingClientRect()
            const { minWidth, maxWidth } = getBounds()
            const rawWidth = event.clientX - left
            const nextWidth = Math.min(maxWidth, Math.max(minWidth, rawWidth))
            setSidebarWidth(nextWidth)
        }

        const onMouseUp = () => {
            sidebarResizer.classList.remove('dragging')
            const styles = window.getComputedStyle(sidebarContainer)
            const widthPx = parseFloat(styles.width)
            if (!Number.isNaN(widthPx)) {
                localStorage.setItem('sidebar-width', String(widthPx))
            }
            window.removeEventListener('mousemove', onMouseMove)
            window.removeEventListener('mouseup', onMouseUp)
        }

        sidebarResizer.addEventListener('mousedown', (event) => {
            if (sidebarContainer.classList.contains('collapsed')) {
                return
            }

            event.preventDefault()
            sidebarResizer.classList.add('dragging')
            window.addEventListener('mousemove', onMouseMove)
            window.addEventListener('mouseup', onMouseUp)
        })
    }
</script>

<!-- Mobile Navigation -->
<script>
    const menuButton = document.getElementById(
        'menu-button',
    ) as HTMLButtonElement
    const docsButton = document.getElementById(
        'docs-button',
    ) as HTMLButtonElement
    const sidebarContainer = document.getElementById(
        'sidebar-container',
    ) as HTMLDivElement
    const article = document.querySelector('article') as HTMLElement

    menuButton.addEventListener('click', () => {
        sidebarContainer.classList.remove('mobile-hidden')
        article.classList.add('mobile-hidden')
        menuButton.setAttribute('variant-', '')
        docsButton.setAttribute('variant-', 'background1')
    })

    docsButton.addEventListener('click', () => {
        sidebarContainer.classList.add('mobile-hidden')
        article.classList.remove('mobile-hidden')
        menuButton.setAttribute('variant-', 'background1')
        docsButton.setAttribute('variant-', '')
    })
</script>
